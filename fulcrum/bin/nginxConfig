#!/bin/sh

# see if we have a conf to process first
if [[ -e /fulcrum/conf/tmp.vars && ! -z $1 && ! -z $2 ]]; then
  echo "Writing $2.json from $1: /usr/bin/envsubst < /fulcrum/conf/$1 > /fulcrum/conf/$2.json"
  source /fulcrum/conf/tmp.vars
  /usr/bin/envsubst < /fulcrum/conf/$1 > /fulcrum/conf/$2.json
fi

echo "Writing nginx conf from conf/*.json"
node /fulcrum/node/fulcrumConfs.js    /fulcrum/conf > /fulcrum/etc/nginx/fulcrum/fulcrum_config.conf
node /fulcrum/node/fulcrumEnvs.js     /fulcrum/conf > /fulcrum/etc/nginx/fulcrum/fulcrum_env.conf
node /fulcrum/node/fulcrumWebroots.js /fulcrum/conf > /fulcrum/etc/nginx/fulcrum/fulcrum_webroot.conf